# FinanceFlo.ai — Claude Code / Cursor Context

This file provides Claude Code (Cursor) with the full context needed to work on this project effectively.

---

## Project Identity

**Name:** FinanceFlo.ai
**Type:** Lead-generation and consulting-sales platform (NOT a SaaS product)
**Owner:** Dudley Peacock — AI-powered financial transformation consultant
**Positioning:** "We redesign how growing companies operate. AI is just one tool in the system."
**Website:** https://financeflo.ai
**Email:** dudley@financeflo.ai

This is a **public-facing marketing and sales tool** that converts CFOs and Finance Directors into qualified leads through an interactive AI Readiness Assessment quiz funnel, automated proposal generation, and workshop registration — all integrated with GoHighLevel (GHL) for CRM automation.

---

## Tech Stack

| Layer | Technology | Notes |
|-------|-----------|-------|
| Frontend | React 19 + Tailwind CSS 4 + shadcn/ui | Dark theme, wouter routing, Framer Motion animations |
| Backend | Express 4 + tRPC 11 + Superjson | All API via `/api/trpc` |
| Database | TiDB (MySQL-compatible) + Drizzle ORM | Schema in `drizzle/schema.ts` |
| Auth | Manus OAuth (session cookie) | `protectedProcedure` for admin routes |
| LLM | Built-in Forge API | Proposal generation via `server/proposalGenerator.ts` |
| Storage | S3 | PDF proposals via `server/storage.ts` |
| CRM | GoHighLevel webhooks | Fire-and-forget via `server/ghl.ts` |
| Testing | Vitest | 50 tests across 3 files |

### Key Commands

```bash
pnpm dev          # Start dev server (tsx watch)
pnpm test         # Run vitest
pnpm build        # Production build (vite + esbuild)
pnpm db:push      # Generate + migrate database schema
```

---

## File Structure — What to Edit

```
client/src/pages/         ← Page components (Home, Assessment, Results, Solutions, Workshop, etc.)
client/src/components/    ← Reusable UI (Navbar, Footer, shadcn/ui)
client/src/index.css      ← Global theme tokens and custom CSS
client/src/App.tsx        ← Route definitions

server/routers.ts         ← All tRPC API endpoints (lead, assessment, proposal, workshop)
server/db.ts              ← Database query helpers (Drizzle)
server/ghl.ts             ← GoHighLevel webhook integration
server/proposalGenerator.ts ← LLM-powered proposal content generation
server/pdfGenerator.ts    ← Branded HTML-to-PDF + S3 upload

shared/pricing.ts         ← Region-based pricing config (UK/EU/ZA) — SINGLE SOURCE OF TRUTH
shared/const.ts           ← Shared constants
shared/types.ts           ← Shared TypeScript types

drizzle/schema.ts         ← Database tables (leads, assessments, proposals, workshopRegistrations, webhookEvents)
```

### DO NOT EDIT

```
server/_core/             ← Framework plumbing (OAuth, context, Vite bridge, LLM helpers)
client/src/_core/         ← Auth hooks (useAuth)
```

---

## Business Frameworks — CRITICAL CONTEXT

### Constraint-Based Sales (NOT feature-based)

The entire platform is built around diagnosing **constraints**, not selling features. Every piece of copy, every quiz question, and every proposal must use constraint language:

| Constraint | Signal | Question |
|-----------|--------|----------|
| **Capacity** | Volume too high, team drowning | "What breaks if volume doubles in 90 days?" |
| **Knowledge** | Inconsistent answers, tribal knowledge | "When a key person leaves, what processes break?" |
| **Process** | Bad handoffs, bottlenecks | "Walk me through your month-end. Where does it stall?" |
| **Scale** | Everything breaks at 2x volume | "Can you grow without proportionally growing cost?" |

### QDOAA Framework (Before AI)

Always apply QDOAA before recommending any AI solution:
1. **Question** — Why does this step exist?
2. **Delete** — Remove purposeless steps
3. **Optimise** — Improve remaining steps manually
4. **Accelerate** — Make faster without adding people
5. **Automate** — NOW add AI to what remains

### ADAPT Framework (Engagement Delivery)

| Phase | Name | Description |
|-------|------|-------------|
| A | Assess | Map constraints, calculate Cost of Inaction, identify quick wins |
| D | Design | Architect Sage Intacct config + AI integration roadmap |
| A | Automate | Implement automation across highest-impact bottlenecks |
| P | Pilot | Deploy with measurable KPIs, prove ROI fast |
| T | Transform | Scale AI across organisation with continuous optimisation |

### 5 ROI Levers (Growth Capacity)

When writing proposals or copy, frame value through these levers:
1. **Time saved** — operational efficiency
2. **Error reduction** — quality + compliance
3. **Throughput increase** — capacity without hiring
4. **Conversion lift** — revenue optimisation
5. **Risk avoidance** — protect existing revenue

---

## Regional Pricing — MANDATORY RULES

### Rule 1: All pricing is region-aware

The platform supports three regions: **UK (GBP)**, **EU (EUR)**, **ZA (ZAR)**. The single source of truth for all pricing is `shared/pricing.ts`. Never hardcode prices — always use the `REGION_CONFIGS`, `formatCurrency()`, `formatRange()`, and `getEngagementTiers()` functions.

### Rule 2: Hourly rates are NEVER displayed

Hourly rates exist in the config for internal calculations (Cost of Inaction, ROI modelling) but must **never** appear on the website, in proposals, or in any client-facing output. Only project-based pricing (audit ranges, retainer ranges) is shown.

### Rule 3: Pricing disclaimer is mandatory

Every page or document that shows pricing must include the disclaimer from `PRICING_DISCLAIMER` in `shared/pricing.ts`:

> "All pricing is indicative, not fixed, and excludes VAT / Sales Tax. Projects are delivered on a time-and-materials basis. Actual costs depend on project scope, and additional fees may apply for out-of-scope work based on actual hours consumed."

### Rule 4: Default currency is GBP

When no region is detected, default to UK (GBP). The user's consulting fees are always denominated in GBP by default.

### Current Rates

| Service | UK (GBP) | EU (EUR) | ZA (ZAR) |
|---------|----------|----------|----------|
| Consultant/hr | £110 | €180 | R975 |
| Senior Consultant/hr | £170 | €180 | R1,850 |
| AI Operations Audit | £5k–£15k | €5k–€15k | R45k–R175k |
| Monthly Retainer | £5k–£7.5k | €5k–€7.5k | R30k–R75k |

---

## Database Schema (5 Tables)

| Table | Purpose |
|-------|---------|
| `leads` | Captured prospects (name, email, company, source, archetype, GHL ID, UTM params) |
| `assessments` | Quiz submissions (answers JSON, constraint scores, overall score, recommended tier) |
| `proposals` | Generated proposals (content JSON, PDF URL, status, estimated value) |
| `workshopRegistrations` | Workshop signups (workshop ID, status, prep/survey/certificate flags) |
| `webhookEvents` | GHL webhook audit log (event type, payload, response status) |

After editing `drizzle/schema.ts`, always run `pnpm db:push` to generate and apply migrations.

---

## API Patterns

### Public endpoints (no auth required)

Used for lead capture, assessment submission, proposal generation, and workshop registration. These are the main conversion funnel endpoints.

### Protected endpoints (admin only)

Used for listing leads, updating proposal status, managing workshop registrations. Require Manus OAuth session.

### GHL Webhook Pattern

Every mutation that creates a lead, assessment, proposal, or workshop registration fires a GHL webhook asynchronously:

```typescript
sendToGHL("event_type", payload).catch(err => console.error("[GHL]", err));
```

The `GHL_WEBHOOK_URL` env var must be set. All events are logged to `webhookEvents` table.

---

## Design System — "Data Cartography"

### Colours (OKLCH)

| Token | OKLCH | Hex | Usage |
|-------|-------|-----|-------|
| `navy` | `oklch(0.15 0.03 260)` | #0A1628 | Primary background |
| `navy-dark` | `oklch(0.10 0.03 260)` | — | Deeper sections |
| `teal` | `oklch(0.78 0.15 175)` | #00D4AA | Interactive elements, data highlights |
| `amber` | `oklch(0.78 0.15 75)` | #F5A623 | CTAs, warnings, urgency |
| `cream` | `oklch(0.95 0.01 80)` | #F0EDE8 | Body text |

### Typography

| Role | Font | Weight |
|------|------|--------|
| Headlines | Space Grotesk | Bold (700) |
| Body | DM Sans | Regular (400) |
| Data/Stats | JetBrains Mono | Medium (500) |

### Visual Rules

1. Dark theme only — deep navy canvas
2. Glass-panel effects for content cards (`backdrop-blur`, subtle border glow)
3. Topographic contour line patterns as section dividers
4. Animations: slow, deliberate (200ms ease-out), Framer Motion scroll reveals
5. No bouncing, no elastic — everything measured and precise
6. Asymmetric layouts with annotation-style callouts

---

## User Flows

### Primary: Quiz Funnel

```
Home → "Diagnose Your Constraints" CTA
  → Assessment (10 questions + region detection + contact form)
    → lead.create mutation → GHL webhook
    → assessment.submit mutation → GHL webhook
  → Results page (constraint diagnosis + Cost of Inaction + recommended tier)
    → "Generate Proposal" → proposal.generate mutation (LLM) → GHL webhook
    → "Download PDF" → proposal.generatePdf mutation (S3)
    → CTA: Book strategy call
```

### Secondary: Workshop Registration

```
Workshop page → Registration form
  → lead.create mutation → GHL webhook
  → workshop.register mutation → GHL webhook
  → Confirmation with next steps
```

### Tertiary: Lead Magnet

```
Lead Magnet page → Email capture form
  → lead.create mutation → GHL webhook
  → PDF download
```

---

## Testing

Run all tests: `pnpm test`

| File | Tests | What it covers |
|------|-------|---------------|
| `server/routes.test.ts` | 26 | All tRPC endpoints, auth guards, GHL webhook firing, input validation |
| `shared/pricing.test.ts` | 23 | Region configs, currency formatting, range formatting, engagement tiers, disclaimer |
| `server/auth.logout.test.ts` | 1 | Auth logout flow |

Tests mock `db`, `ghl`, `proposalGenerator`, and `pdfGenerator` modules. When adding new endpoints, follow the pattern in `routes.test.ts`.

---

## Environment Variables

| Variable | Source | Purpose |
|----------|--------|---------|
| `DATABASE_URL` | System | TiDB connection string |
| `JWT_SECRET` | System | Session cookie signing |
| `BUILT_IN_FORGE_API_URL` | System | LLM + storage API |
| `BUILT_IN_FORGE_API_KEY` | System | Server-side API key |
| `GHL_WEBHOOK_URL` | User | GoHighLevel webhook endpoint |

Do not hardcode env values. Reference them via `server/_core/env.ts`.

---

## Common Tasks

### Add a new page

1. Create `client/src/pages/NewPage.tsx`
2. Add route in `client/src/App.tsx`
3. Add nav link in `client/src/components/Navbar.tsx`

### Add a new API endpoint

1. Add query helper in `server/db.ts`
2. Add procedure in `server/routers.ts`
3. Add test in `server/routes.test.ts`
4. Call from frontend with `trpc.router.procedure.useQuery/useMutation`

### Update pricing

Edit `shared/pricing.ts` only. All pages and generators import from there. Run `pnpm test` to verify.

### Add a new database table

1. Define table in `drizzle/schema.ts`
2. Run `pnpm db:push`
3. Add query helpers in `server/db.ts`

---

## Key Documentation

| Document | Path | Purpose |
|----------|------|---------|
| PRD | `docs/PRD.md` | Full product requirements, architecture, pricing, roadmap |
| Pricing Research | `research/pricing-research-all-regions.md` | Market validation data for all regions |
| Design Brainstorm | `ideas.md` | Original design concept exploration |
| CDN URLs | `cdn-urls.md` | All uploaded image asset URLs |
| TODO | `todo.md` | Feature tracking with completion status |

---

## Tone and Copy Guidelines

When writing any client-facing copy for this project:

1. **Professional but direct** — consultant, not salesperson
2. **Evidence-based, not hype** — always cite data, never use superlatives
3. **Constraint language** — "Where does your business break?" not "What features do you want?"
4. **Severity framing** — frame as insurance/certainty, not a project quote
5. **Cost of Inaction** — always quantify what doing nothing costs
6. **Verbatim quotes** — "You said X, so we built Y" pattern in proposals
7. **QDOAA before AI** — never recommend AI without first questioning, deleting, optimising, accelerating
